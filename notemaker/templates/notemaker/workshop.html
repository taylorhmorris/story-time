{% load static %}

<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/alpinejs" defer></script>
  <script src="https://unpkg.com/htmx.org@1.9.5" integrity="sha384-xcuj3WpfgjlKF+FXhSQFQ0ZNr39ln+hwjN3npfM9VBnUskLolQAcN80McRIVOPuO" crossorigin="anonymous" defer></script>
  <link rel="stylesheet" type="text/css" href="{% static 'notemaker/css/ankicard-workshop.css' %}">
</head>
<body>

  <div class="workshop" x-data="workshopData()">
    <div class="story">A l'orée d'une grande forêt vivaient un pauvre bûcheron, sa femme et ses deux enfants. Le garçon s'appelait Hansel et la fille Grethel. La famille ne mangeait guère.

    Une année que la famine régnait dans le pays et que le pain lui-même vint à manquer, le bûcheron ruminait des idées noires, une nuit, dans son lit et remâchait ses soucis. Il dit à sa femme - Qu'allons-nous devenir ? Comment nourrir nos pauvres enfants, quand nous n'avons plus rien pour nous-mêmes ? - Eh bien, mon homme, dit la femme, sais-tu ce que nous allons faire ?

    Dès l'aube, nous conduirons les enfants au plus profond de la forêt nous leur allumerons un feu et leur donnerons à chacun un petit morceau de pain. Puis nous irons à notre travail et les laisserons seuls. Ils ne retrouveront plus leur chemin et nous en serons débarrassés. - Non, femme, dit le bûcheron. je ne ferai pas cela ! Comment pourrais-je me résoudre à laisser nos enfants tout seuls dans la forêt ! Les bêtes sauvages ne tarderaient pas à les dévorer. - Oh ! fou, rétorqua-t-elle, tu préfères donc que nous mourions de faim tous les quatre ? Alors, il ne te reste qu'à raboter les planches de nos cercueils.

    Elle n'eut de cesse qu'il n'acceptât ce qu'elle proposait. - Mais j'ai quand même pitié de ces pauvres enfants, dit le bûcheron. Les deux petits n'avaient pas pu s'endormir tant ils avaient faim. Ils avaient entendu ce que la marâtre disait à leur père. Grethel pleura des larmes amères et dit à son frère : - C'en est fait de nous - Du calme, Grethel, dit Hansel. Ne t'en fais pas ; Je trouverai un moyen de nous en tirer.

    Quand les parents furent endormis, il se leva, enfila ses habits, ouvrit la chatière et se glissa dehors. La lune brillait dans le ciel et les graviers blancs, devant la maison, étincelaient comme des diamants. Hansel se pencha et en mit dans ses poches autant qu'il put. Puis il rentra dans la maison et dit à Grethel : - Aie confiance, chère petite sœur, et dors tranquille. Dieu ne nous abandonnera pas. Et lui-même se recoucha.</div>

    <div id="modal" class="modal-content" x-show="$store.noteStore.reviewModalToggle" x-cloak>
      <span class="close" @click="$store.noteStore.reviewModalToggle = false">&times;</span>
      <div id="resultWindow" class="result-content">
      </div>
    </div>
  </div>

<script type="text/javascript">

function spanifyWords(div){
    let text = div.innerHTML;
    div.innerHTML = "<span class='singleWord'>" +
      text.replace(/[ \n\r\s\t]/g, "</span> <span class='singleWord'>") + "</span>";
}

function spanifyStory(){
  (document.querySelectorAll(".story") || []).forEach((element, index) => {
    element.innerHTML = 
      "<span class='singleSentence'>" + 
      element
      .textContent
      .replace(
        /[.!?][ \n\r\s\t]/g,
        function(m){
          return m[0]+"</span>"+m[1]+"<span class='singleSentence'>"
        }) + "</span>";
    (element.querySelectorAll(".singleSentence") || []).forEach((element, index) => {
      spanifyWords( element )
    });
  });
};

document.addEventListener("DOMContentLoaded", () => {
  spanifyStory();
  (document.querySelectorAll(".singleWord") || []).forEach((element, index) => {
    element.addEventListener('click', (event) => {
      let word = event.target.textContent.toLowerCase().replace(/[^a-zÀ-ú ']/gi, "");
      console.log("word clicked: " + word);
      console.log("parent of clicked: " + event.target.parentNode.textContent)
      Alpine.store('noteStore').checkSubmission(word);
    });   
  });
});
</script>

<script type="text/javascript">
  document.addEventListener('alpine:init', () => {
    Alpine.store('noteStore', {
      reviewModalToggle: false,
      checkSubmission(word) {
        console.log('word clicked')
          this.reviewModalToggle = true;
          htmx.ajax(
            'GET',
            "{% url 'notemaker:htmx-generate-note' %}" + `?word=${word}`,
            {
              target: "#resultWindow",
              swap: "outerHTML",
            }
          )
      },
    })
  })
</script>
</body>
</html>


